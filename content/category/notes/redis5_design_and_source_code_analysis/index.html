<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>《Redis 5 设计与源码分析》 学习笔记 | G-Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <meta name="description" content="Go the extra mile.">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/mstile-150x150.png">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.9cfe8a24.css" as="style"><link rel="preload" href="/assets/js/app.581ce651.js" as="script"><link rel="preload" href="/assets/js/4.97ffefa2.js" as="script"><link rel="preload" href="/assets/js/1.dc92cade.js" as="script"><link rel="preload" href="/assets/js/6.920bd8f9.js" as="script"><link rel="preload" href="/assets/js/14.58c020f3.js" as="script"><link rel="prefetch" href="/assets/js/10.67d2e0c4.js"><link rel="prefetch" href="/assets/js/100.9b2d34a5.js"><link rel="prefetch" href="/assets/js/101.9774797a.js"><link rel="prefetch" href="/assets/js/102.e365ae5c.js"><link rel="prefetch" href="/assets/js/103.521200b4.js"><link rel="prefetch" href="/assets/js/104.a3754030.js"><link rel="prefetch" href="/assets/js/105.a87b67db.js"><link rel="prefetch" href="/assets/js/106.9d772e3a.js"><link rel="prefetch" href="/assets/js/107.d7ee29a7.js"><link rel="prefetch" href="/assets/js/108.9b2c7763.js"><link rel="prefetch" href="/assets/js/109.2bec1f5c.js"><link rel="prefetch" href="/assets/js/11.3f2da3a1.js"><link rel="prefetch" href="/assets/js/110.6c95cbea.js"><link rel="prefetch" href="/assets/js/111.5dbc80bb.js"><link rel="prefetch" href="/assets/js/112.d348007f.js"><link rel="prefetch" href="/assets/js/113.b0829511.js"><link rel="prefetch" href="/assets/js/114.de8b1d20.js"><link rel="prefetch" href="/assets/js/115.652f8688.js"><link rel="prefetch" href="/assets/js/116.896496b7.js"><link rel="prefetch" href="/assets/js/117.12f7cef7.js"><link rel="prefetch" href="/assets/js/118.ad889b97.js"><link rel="prefetch" href="/assets/js/119.a54fdfd6.js"><link rel="prefetch" href="/assets/js/12.b9f15978.js"><link rel="prefetch" href="/assets/js/120.6c4bdf5f.js"><link rel="prefetch" href="/assets/js/121.df6730db.js"><link rel="prefetch" href="/assets/js/122.2a275f41.js"><link rel="prefetch" href="/assets/js/123.9807d2b8.js"><link rel="prefetch" href="/assets/js/124.8431c2c4.js"><link rel="prefetch" href="/assets/js/125.86cbe442.js"><link rel="prefetch" href="/assets/js/126.05050fd3.js"><link rel="prefetch" href="/assets/js/127.c00746eb.js"><link rel="prefetch" href="/assets/js/128.51bbada1.js"><link rel="prefetch" href="/assets/js/129.b380fa2b.js"><link rel="prefetch" href="/assets/js/13.c7c524aa.js"><link rel="prefetch" href="/assets/js/130.7fc90bed.js"><link rel="prefetch" href="/assets/js/131.96216d20.js"><link rel="prefetch" href="/assets/js/132.c122f459.js"><link rel="prefetch" href="/assets/js/133.1fdb76d4.js"><link rel="prefetch" href="/assets/js/134.518ae25d.js"><link rel="prefetch" href="/assets/js/135.cf819178.js"><link rel="prefetch" href="/assets/js/136.6098d36f.js"><link rel="prefetch" href="/assets/js/137.e699fe29.js"><link rel="prefetch" href="/assets/js/138.75e02aa1.js"><link rel="prefetch" href="/assets/js/139.3a816931.js"><link rel="prefetch" href="/assets/js/140.af44cd93.js"><link rel="prefetch" href="/assets/js/141.a6fae549.js"><link rel="prefetch" href="/assets/js/142.30b5ac31.js"><link rel="prefetch" href="/assets/js/143.198ae7e6.js"><link rel="prefetch" href="/assets/js/144.9afeb735.js"><link rel="prefetch" href="/assets/js/145.c7ac0e0a.js"><link rel="prefetch" href="/assets/js/146.ef17605e.js"><link rel="prefetch" href="/assets/js/147.df459a27.js"><link rel="prefetch" href="/assets/js/148.f60f6b0c.js"><link rel="prefetch" href="/assets/js/149.b55c469c.js"><link rel="prefetch" href="/assets/js/15.8d234fd6.js"><link rel="prefetch" href="/assets/js/150.162b6d5c.js"><link rel="prefetch" href="/assets/js/151.6b73d29b.js"><link rel="prefetch" href="/assets/js/152.89481802.js"><link rel="prefetch" href="/assets/js/153.3733191e.js"><link rel="prefetch" href="/assets/js/154.9827f77e.js"><link rel="prefetch" href="/assets/js/155.78fc5416.js"><link rel="prefetch" href="/assets/js/156.c8e08d51.js"><link rel="prefetch" href="/assets/js/157.61092973.js"><link rel="prefetch" href="/assets/js/158.a57330da.js"><link rel="prefetch" href="/assets/js/159.3233ebbd.js"><link rel="prefetch" href="/assets/js/16.4595c8be.js"><link rel="prefetch" href="/assets/js/160.0926e9b2.js"><link rel="prefetch" href="/assets/js/161.a677904a.js"><link rel="prefetch" href="/assets/js/162.fcbd1565.js"><link rel="prefetch" href="/assets/js/163.e5163396.js"><link rel="prefetch" href="/assets/js/164.171802cc.js"><link rel="prefetch" href="/assets/js/165.ae291a75.js"><link rel="prefetch" href="/assets/js/17.d7d9620e.js"><link rel="prefetch" href="/assets/js/18.74f2e68c.js"><link rel="prefetch" href="/assets/js/19.e0236b6c.js"><link rel="prefetch" href="/assets/js/20.b47ef444.js"><link rel="prefetch" href="/assets/js/21.b3275e95.js"><link rel="prefetch" href="/assets/js/22.6c775431.js"><link rel="prefetch" href="/assets/js/23.88917934.js"><link rel="prefetch" href="/assets/js/24.9d728d89.js"><link rel="prefetch" href="/assets/js/25.d967de61.js"><link rel="prefetch" href="/assets/js/26.a072e7ef.js"><link rel="prefetch" href="/assets/js/27.00efea3a.js"><link rel="prefetch" href="/assets/js/28.e0cd2d9a.js"><link rel="prefetch" href="/assets/js/29.17caf06e.js"><link rel="prefetch" href="/assets/js/30.7fc3791a.js"><link rel="prefetch" href="/assets/js/31.4857cfe0.js"><link rel="prefetch" href="/assets/js/32.05288ab1.js"><link rel="prefetch" href="/assets/js/33.fa0cb4c3.js"><link rel="prefetch" href="/assets/js/34.9b416678.js"><link rel="prefetch" href="/assets/js/35.9cb00cbf.js"><link rel="prefetch" href="/assets/js/36.1cf97ce7.js"><link rel="prefetch" href="/assets/js/37.d5364c28.js"><link rel="prefetch" href="/assets/js/38.45d84fe0.js"><link rel="prefetch" href="/assets/js/39.b4791e3c.js"><link rel="prefetch" href="/assets/js/40.ebae2489.js"><link rel="prefetch" href="/assets/js/41.9414e373.js"><link rel="prefetch" href="/assets/js/42.1f072039.js"><link rel="prefetch" href="/assets/js/43.7b5a22a0.js"><link rel="prefetch" href="/assets/js/44.fe9d7516.js"><link rel="prefetch" href="/assets/js/45.c8b37402.js"><link rel="prefetch" href="/assets/js/46.c584bfe9.js"><link rel="prefetch" href="/assets/js/47.abaeb33c.js"><link rel="prefetch" href="/assets/js/48.6743f226.js"><link rel="prefetch" href="/assets/js/49.98094bba.js"><link rel="prefetch" href="/assets/js/5.0056b2bb.js"><link rel="prefetch" href="/assets/js/50.5964535a.js"><link rel="prefetch" href="/assets/js/51.fc3a3776.js"><link rel="prefetch" href="/assets/js/52.0fc69069.js"><link rel="prefetch" href="/assets/js/53.1dcf48f4.js"><link rel="prefetch" href="/assets/js/54.0335241c.js"><link rel="prefetch" href="/assets/js/55.11e6f5c6.js"><link rel="prefetch" href="/assets/js/56.9939c258.js"><link rel="prefetch" href="/assets/js/57.cb899d1c.js"><link rel="prefetch" href="/assets/js/58.cb239b03.js"><link rel="prefetch" href="/assets/js/59.0887733f.js"><link rel="prefetch" href="/assets/js/60.786371bf.js"><link rel="prefetch" href="/assets/js/61.eceb7181.js"><link rel="prefetch" href="/assets/js/62.c4e9c350.js"><link rel="prefetch" href="/assets/js/63.d21da78f.js"><link rel="prefetch" href="/assets/js/64.72ac8cce.js"><link rel="prefetch" href="/assets/js/65.e97419b7.js"><link rel="prefetch" href="/assets/js/66.1f2c8020.js"><link rel="prefetch" href="/assets/js/67.8f3b6855.js"><link rel="prefetch" href="/assets/js/68.d05a0f02.js"><link rel="prefetch" href="/assets/js/69.36f63bd4.js"><link rel="prefetch" href="/assets/js/7.a6598389.js"><link rel="prefetch" href="/assets/js/70.242a88c9.js"><link rel="prefetch" href="/assets/js/71.7e311c54.js"><link rel="prefetch" href="/assets/js/72.ccdf1ddd.js"><link rel="prefetch" href="/assets/js/73.ca80905e.js"><link rel="prefetch" href="/assets/js/74.345d6866.js"><link rel="prefetch" href="/assets/js/75.7b260fa1.js"><link rel="prefetch" href="/assets/js/76.d6c8a2e7.js"><link rel="prefetch" href="/assets/js/77.d6bbecb5.js"><link rel="prefetch" href="/assets/js/78.6f42e2ad.js"><link rel="prefetch" href="/assets/js/79.5b7100b4.js"><link rel="prefetch" href="/assets/js/8.586c77e4.js"><link rel="prefetch" href="/assets/js/80.36914878.js"><link rel="prefetch" href="/assets/js/81.d8751e00.js"><link rel="prefetch" href="/assets/js/82.2e19b9ab.js"><link rel="prefetch" href="/assets/js/83.ab8ccb09.js"><link rel="prefetch" href="/assets/js/84.5d9ae3a8.js"><link rel="prefetch" href="/assets/js/85.0e7f4eb7.js"><link rel="prefetch" href="/assets/js/86.99ffd779.js"><link rel="prefetch" href="/assets/js/87.25a9f60d.js"><link rel="prefetch" href="/assets/js/88.ef4335d3.js"><link rel="prefetch" href="/assets/js/89.b94ddbb1.js"><link rel="prefetch" href="/assets/js/9.eefe2ffe.js"><link rel="prefetch" href="/assets/js/90.14d2e81b.js"><link rel="prefetch" href="/assets/js/91.da047a18.js"><link rel="prefetch" href="/assets/js/92.02e963c3.js"><link rel="prefetch" href="/assets/js/93.082526ff.js"><link rel="prefetch" href="/assets/js/94.bae0f91f.js"><link rel="prefetch" href="/assets/js/95.2f7f87f1.js"><link rel="prefetch" href="/assets/js/96.6c0631b6.js"><link rel="prefetch" href="/assets/js/97.eb5945fc.js"><link rel="prefetch" href="/assets/js/98.5ccf1f5c.js"><link rel="prefetch" href="/assets/js/99.436aa867.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.2b1ca150.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9cfe8a24.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>G-Blog</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>Go the extra mile.</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>Guanyuqian</span>
            
          <span data-v-4e82dffc>2021 - </span>
          2022
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="G-Blog" class="logo"> <span class="site-name">G-Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  历史
</a></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/算法题解/" class="nav-link"><i class="undefined"></i>
  算法题解
</a></li><li class="dropdown-item"><!----> <a href="/categories/折腾日志/" class="nav-link"><i class="undefined"></i>
  折腾日志
</a></li><li class="dropdown-item"><!----> <a href="/categories/学习笔记/" class="nav-link"><i class="undefined"></i>
  学习笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/个人总结/" class="nav-link"><i class="undefined"></i>
  个人总结
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/content/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></li><li class="dropdown-item"><!----> <a href="https://guanyuqian.github.io/rss.xml" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-rss"></i>
  订阅
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/guanyuqian" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="mailto:the_sam@foxmail.com" class="nav-link external"><i class="iconfont reco-mail"></i>
  E-Mail
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    Guanyuqian
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>149</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>98</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  历史
</a></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/算法题解/" class="nav-link"><i class="undefined"></i>
  算法题解
</a></li><li class="dropdown-item"><!----> <a href="/categories/折腾日志/" class="nav-link"><i class="undefined"></i>
  折腾日志
</a></li><li class="dropdown-item"><!----> <a href="/categories/学习笔记/" class="nav-link"><i class="undefined"></i>
  学习笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/个人总结/" class="nav-link"><i class="undefined"></i>
  个人总结
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/content/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></li><li class="dropdown-item"><!----> <a href="https://guanyuqian.github.io/rss.xml" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-rss"></i>
  订阅
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/guanyuqian" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="mailto:the_sam@foxmail.com" class="nav-link external"><i class="iconfont reco-mail"></i>
  E-Mail
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>《Redis 5 设计与源码分析》 学习笔记</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>Guanyuqian</span>
            
          <span data-v-4e82dffc>2021 - </span>
          2022
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">《Redis 5 设计与源码分析》 学习笔记</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>Guanyuqian</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>4/15/2021</span></i> <!----> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>Redis</span><span class="tag-item" data-v-1ff7123e>数据库</span></i></div></div> <div class="theme-reco-content content__default"><div class="custom-block warning"><p class="title"></p><p>关于Redis 5设计、数据结构、底层命令实现，以及持久化、主从复制、集群的实现。</p></div> <h2 id="第一章-引言"><a href="#第一章-引言" class="header-anchor">#</a> 第一章 引言</h2> <p><strong>为什么Redis的性能高</strong>：</p> <ol><li>内存：因为Redis是基于内存的存储数据库。</li> <li>单线程：Redis使用单线程来处理网络请求，避免了不必要的上下文切换与线程同步的操作。</li> <li>并发：使用I/O多路复用，可以高效处理大量并发连接</li> <li>数据结构：Redis中的数据结构经过特殊设计，确保操作的高效性</li></ol> <p><strong>Redis的优点</strong>：</p> <ol><li>运行速度快：基于内存的数据库、单线程 IO多路复用</li> <li>支持复杂数据结构：支持字符串、链表、集合、散列表、有序列表等数据结构</li> <li>支持数据持久化：可以采用RDB、AOF、RDB&amp;AOF三种方案，计算机重启后可以在磁盘中进行数据恢复</li> <li>支持主从结构：可以使用从实例进行数据备份</li> <li>操作具有原子性：所有 Redis 操作都是原子操作，这确保如果两个客户端并发访问，Redis 服务器能接收更新的值。</li> <li>多实用工具： Redis 是一个多实用工具，可用于多种用例，如：缓存，消息队列(Redis 本地支持发布/订阅)，应用程序中的任何短期数据，例如，web应用程序中的会话，网页命中计数等。</li></ol> <h2 id="第二章-简单动态字符串"><a href="#第二章-简单动态字符串" class="header-anchor">#</a> 第二章 简单动态字符串</h2> <img src="/assets/img/sds.43aa2f75.png" alt="SDS" style="zoom:75%;"> <p>​	<strong>SDS优点</strong></p> <ul><li><p>二进制安全：Redis的SDS是二进制安全的，通过柔型数组（统计长度、空间）来实现SDS，而不是转义符'\0'。</p></li> <li><p>自适应多类型节约空间：分成5种类型，不同结构之间记录长度和空间的变量大小不同的头的大小不一样，Redis可以根据SDS长度自动为其选择不同的数据结构</p></li> <li><ul><li>sdshdr5：2^5字节以内字符串，耗费1字节的头来记录</li> <li>sdshdr8：2^8字节以内字符串，耗费2字节+3位的头来记录</li> <li>sdshdr16：2^16字节以内字符串，耗费4字节+3位的头来记录</li> <li>sdshdr32：2^32字节以内字符串，耗费8字节+3位的头来记录</li> <li>sdshdr64：2^64字节以内字符串，耗费16字节+3位的头来记录</li></ul></li></ul> <p><strong>SDS API</strong></p> <ul><li><strong>创建字符串</strong>：Redis通过sdsnewlen函数创建SDS。在函数中会根据字符串长度选择合适的类型，初始化完相应的统计值后，返回指向字符串内容的指针。</li> <li><strong>释放字符串</strong>：SDS除了提供释放内存的释放方法，还提供清空状态头的释放方法来优化性能。</li> <li><strong>拼接字符串</strong>：拼接两个字符串，如果长度不够就会自动扩容和选择合适的数据结构存储新的值。</li> <li><strong>其他APU</strong>：读操作的复杂度多为O(1)，直接读取成员变量；涉及修改的写操作，则可能会触发扩容。</li></ul> <p><strong>SDD 扩容规则(sdsMakeroomFor)</strong></p> <p>SDS在涉及字符串修改处会调用sdsMakeroomFor函数进行检查，类似c++的vector，</p> <ul><li>请求长度&lt;1MB的，扩容两倍。</li> <li>请求长度&gt;1MB的，扩容1MB。</li></ul> <p><strong>其他</strong></p> <ul><li>sdshdr5字符串进行扩容，会自动升级为sdshdr8以上的字符串。因为sdshrd5字符串的机构和其他字符串不一样。</li> <li>创建空字符串，会默认创建sdshdr8类型的字符串，而不是sdshrd5.</li></ul> <h2 id="第三章-跳跃表"><a href="#第三章-跳跃表" class="header-anchor">#</a> 第三章 跳跃表</h2> <img src="/assets/img/skip_list.cd056e2a.png" alt="img" style="zoom:90%;"> <p>跳跃表是Redis有序集合的一种实现方式，特点是平均操作效率接近红黑树O(logN)，但实现比红黑树简单。</p> <p><strong>跳跃表组成</strong></p> <ul><li><p>由很多层有序链表构成，高层有序链表是底层有序链表的子集（最底层有序链表包含所有节点）</p></li> <li><p>跳跃表节点包含键、值、后退指针、前进指针层数组</p></li> <li><ul><li>节点的层高为前进指针层数组的长度，是随机生成的（层数越高概率越小）</li> <li>前进指针层由前进指针（forward）和跳过的节点个数(span)组成</li></ul></li> <li><p>跳跃表有一个头节点，头节点中有一个64层的指针结构</p></li> <li><p>跳跃表结构包含头节点指针、尾节点指针、层高、长度</p></li> <li><ul><li>头节点指针（head）：头节点中有一个64层的指针结构</li> <li>尾节点指针（tail）：尾节点为最底层链表的最后一个节点</li> <li>层高（level）：最高层非头节点的值</li> <li>长度（length）：最底层链表的长度</li></ul></li></ul> <p><strong>Redis有序集合实现</strong></p> <ul><li>Redis有序集合有跳跃表和压缩列表两种实现方式，底层自动转换用户层无感。</li> <li>一般默认采用压缩列表进行实现，当值的长度或者元素个数超过压缩列表的限制就转换成跳跃表，且此过程不可逆。</li></ul> <h2 id="第四章-压缩列表"><a href="#第四章-压缩列表" class="header-anchor">#</a> 第四章 压缩列表</h2> <p>Redis的有序集合、散列和列表都直接或者间接采用了压缩列表。</p> <p>压缩列表ziplist本质上是一个柔性数组的数组，每个entry数据都是一个柔性数组，和sds类似。</p> <img src="/assets/img/ziplist.b3b36df8.png" alt="img" style="zoom:100%;"> <p>压缩列表以时间换空间，把所有的数据压缩在一块连续的内存区域中。</p> <p>压缩列表的增删操作与数组类似，都涉及到内存重新分配和连续数据拷贝。</p> <p>可用使用LZF等压缩算法来对ziplist的内容进行进一步的压缩。</p> <p><strong>压缩列表数据结构</strong></p> <ul><li>zlbytes（长度）</li> <li>zltail（尾元素相对于起始地址的偏移量）</li> <li>zllen（元素个数）</li> <li>entryX（压缩元素）</li></ul> <img src="/assets/img/entry_ziplist.f908fba1.png" alt="img" style="zoom:100%;"> <ul><li>zlend（结尾占位符）</li></ul> <p><strong>连锁更新问题</strong>，压缩列表中每个元素会在开头记录前一个元素的长度previos_entry_length，该尺寸为1字节或5字节。对压缩列表进行删除或者添加有可能造成后续一系列元素的previos_entry_length尺寸的改变，Redis通过在更新结束后判断后续元素的previos_entry_length字段是否改变来进行连锁更新。</p> <h2 id="第五章-字典"><a href="#第五章-字典" class="header-anchor">#</a> 第五章 字典</h2> <p>字典又称散列表，Redis字典具有以下特点：</p> <ul><li><p>支持值为 String、Hash、List、Set、SortedSet的散列表。</p></li> <li><p>采用链地址法来解决Hash冲突</p></li> <li><p>字典结构中存在两张Hash表指针，</p></li> <li><ul><li>初始均执行NULL，</li> <li>正常情况一张指向NULL，另一张执行Hash表实例，</li> <li>Rehash情况下两张均指向Hash表实例，且一大一小相差两倍</li></ul></li> <li><p><strong>扩容和缩容</strong>：字典结构支持扩容和缩容，采取渐进式Rehash策略</p></li> <li><p><strong>遍历</strong>：支持全遍历和简短遍历</p></li> <li><ul><li><p><strong>全遍历</strong>：一次命令执行就遍历完整个数据库。</p></li> <li><ul><li>普通迭代器，使用期间不能操作字典，因为会引起rehash导致遍历重复</li> <li>安全迭代器，使用期间允许操作字典，通过锁rehash来保证遍历不重复</li></ul></li> <li><p><strong>间断遍历</strong>：每次命令执行只取部分数据，分多次遍历，不锁rehash</p></li> <li><ul><li>采用reverse binary iteration的方法来避免期间出现的rehash造成的遍历错误</li> <li>如果在两部分间断遍历期间完成了多次rehash，可能会造成遍历错误，但是这种情况极少发生，所以没有做特殊处理。</li></ul></li></ul></li></ul> <h2 id="第六章-整数集合"><a href="#第六章-整数集合" class="header-anchor">#</a> 第六章 整数集合</h2> <p>整数集合属于集合的一种，是Redis的一种基本数据结构，用户无感。</p> <ul><li><strong>使用场景</strong>：当集合被创建时只有整数，且数量有限时（默认512个以内），Redis使用整数集合存储。如果插入其他类型数据或者数量过多集合则转变为hashtable结构进行存储。</li> <li><strong>数据结构</strong>：本质上是有序的动态整数数组，分成16位、32位和64位三种类型。</li> <li><strong>操作</strong>：查找、添加、删除操作，因为是有序数组，使用二分查找法加速查找。添加操作可能会插入超出当前整数集合规格的值，此时会进行自动升级。但是没发现Redix有对删除集合后进行自动降级的操作。</li></ul> <h2 id="第七章-快速列表"><a href="#第七章-快速列表" class="header-anchor">#</a> 第七章 快速列表</h2> <p>Redis3.2之前的列表实现方式：Redis采用ziplist和双向链表来实现列表的。压缩列表ziplist有省空间的特点，但是过长的数据会导致操作效率的降低，就使用双向链表adlist进行处理。</p> <p>Redis3.2之后的列表采用快速列表quicklist进行实现，快速列表是ziplist和adlist的结合数据结构，最外层是adlist，其中的节点是ziplist。快速列表支持压缩算法对数据进行进一步的压缩。</p> <img src="/assets/img/quicklist.4457cc21.jpg" alt="img" style="zoom:80%;"> <p>快速列表的增删改查操作就是对具体的每个节点的ziplist进行的增删改查。</p> <ul><li>对于增加：对中间某个已满的节点进行插入操作会导致此节点（假设此节点为 node）的 ziplist 在插入点进行分裂，此时这个 ziplist 会变成两个 ziplist（新建一个 quicklistNode 保存多出来的 ziplist，假设此节点为 newnode），然后将数据插入 node 指向的 ziplist 的末尾，然后对 node 进行 _quicklistMergeNodes 的尝试合并操作。</li> <li>对于删除：提供单个删除和连续删除两个操作，连续删除操作可能会跨节点执行。</li> <li>对于修改：修改会执行删除和增加操作，而不会直接执行修改，因为涉及到ziplist的空间变化问题。</li></ul> <h2 id="第八章-stream"><a href="#第八章-stream" class="header-anchor">#</a> 第八章 Stream</h2> <p>Redis在5.0版本引入了<strong>消息队列</strong>的实现，即Stream组件。</p> <img src="/assets/img/stream.02ba0bea.png" alt="img" style="zoom:30%;"> <p>Redis之前实现pub/sub模式，但是不实用，故设计Stream。Stream的优势在于：</p> <ul><li>支持异步传输，消费者不需要立处理消息。</li> <li>支持消息持久化，Redis宕机了仍然可以处理消息。</li></ul> <p>Stream的设计特点如下：</p> <ul><li><p>由消费者、消费组、消息、消息队列构成。</p></li> <li><p><strong>消息</strong>类似字典（哈希），由多组field-value组成。每个消息有唯一的消息ID，消息ID严格递增。通过listpack和steamNACK进行包装。</p></li> <li><p><strong>消息队列</strong>按提交顺序持久化存储最新（设置的存储上限）的消息。通过Rax树实现。</p></li> <li><p><strong>消费者</strong>可以属于某个消费组。也可以不依赖消费组，可以将不依赖消费组的消费者简单理解为只有一个消费组的消费者，这类消费者在下文用消费组进行概括。</p></li> <li><p><strong>消费组</strong>可以有多个消费者，它们是竞争关系，也就是说一个消息只能由该组的一个消费者消费。消费组都可以消费该消息队列的全部消息，多个消费组之间相互独立。</p></li> <li><ul><li>last delivered id**：消费组**每个消费组有记录访问过的消息索引。</li> <li>streamNACK**：消费组**未确认消息，记录未确认消息的发送时间、消费者等数据。</li> <li>pending entry list，pel**：消费组**都会维护已访问但是没有被确认的消息。通过Rax树实现。</li></ul></li></ul> <p>Stream应用到的特殊数据结构：</p> <ul><li>listpack：批量存储消息，Stream用消息包（listpack）结构体存储消息，listpack中包含多个消息（entryX)，并且按照一定的规则对它们进行了压缩。</li></ul> <img src="/assets/img/listpack.b928a455.png" alt="img" style="zoom:20%;"> <ul><li><p>rax：rax是基数树（压缩前缀树）</p></li> <li><ul><li>stream的消息队列：以消息ID为key，listpack为value，listpack中包含多条消息，因为消息ID是严格递增的，所以key应该是listpack中的第一条消息的ID。</li> <li>消费组的pel：以消息ID为key，streamNACK为value。</li></ul></li></ul> <img src="/assets/img/rax.b4ea1e6a.png" alt="img" style="zoom:50%;"> <h2 id="第九章-命令处理生命周期"><a href="#第九章-命令处理生命周期" class="header-anchor">#</a> 第九章 命令处理生命周期</h2> <p>Redis是CS架构，其服务器属于典型的事件驱动程序。</p> <p>Redis服务器中的重要结构体有：对象结构体、客户端结构体、服务端结构体、命令结构体、事件结构体等。</p> <p><strong>客户端结构体client</strong></p> <p>Redis服务器使用client来维护所有与之连接的客户端信息。</p> <p>包括ID、socket、client对应的数据库实例、待执行客户端命令、待返回值等。</p> <p><strong>服务端结构体redisServer</strong></p> <p>Redis服务器用redisServer维护自身的相关信息。</p> <p>包括端口、命令表、客户端列表以及其他配置参数。</p> <p><strong>命令结构体redisCommand</strong></p> <p>redis把所有可执行的命令用redisCommand维护</p> <p><strong>对象结构体robj</strong></p> <ul><li><strong>robj是key-value数据库中的value</strong>：存储Redis中的key-value对，key只能是字符串，value为对象结构体robj，可以是字符串、列表、集合、有序集合和散列表，这5种数据类型。</li></ul> <img src="/assets/img/robj.3a799364.png" alt="img" style="zoom:80%;"> <ul><li><strong>每种数据类型有多重实现方式</strong>：每种数据类型可以有多种不同的实现方式，这些实现方式是根据数据类型的变化而自动改变的。</li></ul> <img src="/assets/img/reflect.42bc9c4a.png" alt="img" style="zoom:67%;"> <ul><li><p><strong>引用计数</strong>：通过refcount引用计数方法，可以实现对象共享。</p></li> <li><p><strong>LRU策略</strong>：在robj结构体中增加lru辅助字段，实现对对象的LRU缓存淘汰策略。</p></li> <li><p><strong>编码类型</strong>：raw编码是redis的常用编码，字符串的SDS还有embstr编码</p></li> <li><ul><li><strong>raw编码</strong>：先申请对象结构体robj的内存，然后再申请实现结构体的内存，通过robj中的指针指向结构体内存。</li></ul></li></ul> <img src="/assets/img/raw.a3a83e05.png" alt="img" style="zoom:67%;"> <ul><li><ul><li><strong>embstr编码</strong>：当sds比较小时（比如sdshdr8），即可采用embstr编码将sds和robj相邻存储，将两次内存分配（robj、sds）缩短为一次（robj+sds）。</li></ul></li></ul> <img src="/assets/img/embstr.ac4752e5.png" alt="img" style="zoom:75%;"> <p><strong>事件处理</strong></p> <ul><li><p>Redis是事件驱动程序，Redis通过事件处理函数（aeEventLoop）处理所有事件。</p></li> <li><p>Redis的事件分为文件事件和事件事件。</p></li> <li><ul><li>时间事件：定时任务，这类任务相对固定，比如清除异常客户端连接、删除过期数据等。Redis只有一个时间事件，在该事件中再对各种任务进行处理，这个过程类似OS的时钟中断。为了避免任务执行事件过长，时间事件中的任务往往会有执行时间的约束，不全是一次完成。</li> <li>文件事件：基于TCP协议的socket读写相关任务，比如处理和客户端的连接、响应客户端的命令。通过对I/O多路复用的封装，Redis得以在单线程中同时监听多个socket。每次监听socket都会有超时时间，确保在下次时间事件到来之前Redis不会处于监听文件事件的阻塞状态。</li></ul></li></ul> <p><strong>Server的启动过程</strong></p> <img src="/assets/img/server.e2c8e98c.png" alt="img" style="zoom:50%;"> <p><strong>命令处理过程</strong></p> <p>处理命令发生在响应文件任务期间，通过TCP进行数据传输。</p> <p>TCP协议会出现半包和沾包问题，</p> <ul><li>Redis通过自定义传输格式的功能识别TCP的数据包。</li> <li>在客户端client结构中会存储待解析的命令相关信息，解决半包和粘包造成的命令不全问题。</li></ul> <img src="/assets/img/tcp.6155e48a.png" alt="img" style="zoom:80%;"> <p>命令处理过程的流程图如下</p> <img src="/assets/img/command.37a9f489.png" alt="img" style="zoom:75%;"> <p>Redis服务端将待返回的结构存储在客户端的输出缓存区或者输出链表中，随着TCP协议打包返回给客户端。这个过程发生在每次等待文件事件之前的beforesleep函数中。由于返回结果可能会很大，不能一次全部发送给客户端，所以需要通过添加返回结果的写文件事件，通过写文件事件来执行未在beforesleep函数中完成的结果返回任务。</p> <h2 id="第十章-键相关命令"><a href="#第十章-键相关命令" class="header-anchor">#</a> 第十章 键相关命令</h2> <p>两个重要的结构体redisObject和redisDb</p> <ul><li>redisObject：是前面介绍的robj对象，它的结构如下。</li></ul> <img src="/assets/img/robj_struct.62ac8e34.png" alt="img" style="zoom:50%;"> <ul><li>redisDB：Redis对数据库的封装，用来管理数据库相关数据和操作。</li></ul> <p>查看键信息相关命令：</p> <ul><li>object：查看键属性</li> <li>type：查看键类型</li> <li>ttl：查看键过期时间</li></ul> <p>设置键信息相关命令：</p> <ul><li>expire：设置键过期时间</li> <li>persist：删除键过期时间</li> <li>rename：重命名键</li> <li>touch：更新键访问时间</li></ul> <p>查找键相关命令：</p> <ul><li>exist：查询键是否存在</li> <li>keys：阻塞查找符合要求的键</li> <li>scan：异步遍历键（有可能会造成信息重复）</li> <li>randomkey：随机返回键</li></ul> <p>操作键相关命令：</p> <ul><li>del：阻塞删除键</li> <li>unlink：自动选择阻塞同步删除或者非阻塞异步删除键（另一个线程中执行）</li> <li>dump：系列化键</li> <li>restore：反序列化键</li> <li>move：移动键到另一个数据库，在集群模式下不能使用</li> <li>migrate：将键迁移到另一个Redis实例中</li> <li>sort：对键进行排序（内部用块排）</li></ul> <h2 id="第十一章-字符串相关命令"><a href="#第十一章-字符串相关命令" class="header-anchor">#</a> 第十一章 字符串相关命令</h2> <p>设置字符串：</p> <ul><li>set：set命令用于将key-value设置到数据库。可以指定覆盖规则和过期时间</li> <li>mset：批量设置字符串</li> <li></li></ul> <p>修改字符串：</p> <ul><li>append：直接改变底层value的值，不是用set重新覆盖</li> <li>setrange：设置value的部分子串</li> <li>计数器：Redis中数字（int、float）的对象类型是string，通过调用incr/decr/incrby/decrby/incrbyfloat这五个命令，可以对他们进行计数操作。</li></ul> <p>获取字符串：</p> <ul><li>get：get命令用于获取key的值，当key不存在时，返回NIL，当key存在时，返回查找到的结果。</li> <li>getset：更新键对应的值，并返回旧的值。</li> <li>getrange：获取字符串部分子串</li> <li>strlen：获取值字符串长度</li> <li>mget：获取多个key的值</li></ul> <p>位操作字符串：</p> <ul><li><p>setbit：设置指定偏移量上的比特位</p></li> <li><p>getbit：获取指定偏移量上的比特位</p></li> <li><p>bitpos：返回指定偏移后的第一个设置为bit值的索引值</p></li> <li><p>bitcount：统计指定值比特值为1的数量，有多种实现方法</p></li> <li><ul><li>遍历每一位</li> <li>n= n &amp; (n - 1)</li> <li>variable-precision swar算法</li> <li>Redis的实现：查表法+variable-precision swar算法</li></ul></li> <li><p>bitop：对一个或多个key执行元操作</p></li> <li><p>bitfield：将字符串当成一个二进制数组，并对这个字节数组第offset位开始进行获取、设置、增加值等。</p></li></ul> <h2 id="第十二章-散列表相关命令"><a href="#第十二章-散列表相关命令" class="header-anchor">#</a> 第十二章 散列表相关命令</h2> <p>散列表是Redis提供的5种类型之一，底层通过ziplist或者hashtable。</p> <p>当key和value的尺寸长度都不长且元素不多时，采用ziplist进行存储。</p> <p>否则采用hashtable存储。</p> <p>存在由ziplist想hashtable的转化，但是不存在从hashtable转回ziplist。</p> <p>相关命令：</p> <ul><li>设置（hset、hmset、hsetnx）</li> <li>读取（hexists、hget、hmget、hkeys、hvals、hgetall、hlen、hscan）</li> <li>删除（hdel）</li> <li>自增（值为数值类型时，可以进行自增操作，hincrby、hincrbyfloat）</li></ul> <h2 id="第十三章-列表相关命令"><a href="#第十三章-列表相关命令" class="header-anchor">#</a> 第十三章 列表相关命令</h2> <p>列表的底层结构是quicklist、在第七章中进行介绍。quicklist是双向链表和ziplist的结合。</p> <p>相关命令：</p> <ul><li>堆栈命令，值得注意的是列表有阻塞操作，即BLPOP和BRPOP，如果没有成功，则请求的客户端会被放入redisDb的阻塞字典中，待阻塞超时或者满足的资源被提供时才被唤醒。</li></ul> <img src="/assets/img/command2.6b79451a.png" alt="img" style="zoom:50%;"> <ul><li>获取列表数据：lindex、lrange、llen</li> <li>操作命令：lset、linsert、lrem、ltrim</li></ul> <h2 id="第十四章-集合相关命令"><a href="#第十四章-集合相关命令" class="header-anchor">#</a> 第十四章 集合相关命令</h2> <p>集合的底层结构是intset和dict。</p> <p>单个集合相关命令：</p> <ul><li>sadd：添加新成员，涉及到集合底层结构的转换和hashtable的扩容</li> <li>srem：删除成员</li> <li>srandmember：随机获取一个或多个成员</li> <li>spop：随机弹出一个或多个成员，弹出多个成员时如果弹出过多则会更改底层hashtable</li> <li>sismember：查找元素是否在集合中</li> <li>smove：移动指定元素到另一个集合中</li> <li>scard：获取集合中元素个数</li> <li>sscan：遍历集合元素</li></ul> <p>多个集合运算命令：</p> <ul><li>sinter：交集（安装某个集合规则进行排序，以最小集合元素为基本从大到小进行遍历）</li> <li>sinterstore：交集，保存至指定集合</li> <li>sunion：并集</li> <li>sdiff：差集</li></ul> <h2 id="第十五章-有序集合相关命令"><a href="#第十五章-有序集合相关命令" class="header-anchor">#</a> 第十五章 有序集合相关命令</h2> <p>有序集合有两种实现方式：</p> <ul><li>ziplist：如果数据较少或者数据长度不是很长</li> <li>dict + skiplist：在单个元素的定位使用dict来让复杂度降到O(1)</li></ul> <img src="/assets/img/order_list.49f803bb.png" alt="img" style="zoom:50%;"> <p>有序集合的值会有score和member两个参数，分布代表排序相关的分数和值</p> <p>相关命令有：zadd、zrem、zcard、zcount、zincrby、zrank、zrevrank、zscore、zscan、zrange、zrevrange、zrangebyscore、zrevrangebyscore、zrangebylex、zlexcount、zremrangebyrank、zremrangebyscore、zremrangebylex、zunionstore、zinterstore。</p> <h2 id="第十六章geo相关命令"><a href="#第十六章geo相关命令" class="header-anchor">#</a> 第十六章GEO相关命令</h2> <p>geohash是在2008年公开的位置处理算法，能将二维的经纬度信息进行降维存储和计算。</p> <p>相关知识：z阶曲线&amp;geohash算法</p> <ul><li>z阶曲线把二维标拼接用二进制进行存储，对二进制进行Base32编码可以节约存储空间。</li></ul> <img src="/assets/img/z.2a43f8e2.png" alt="img" style="zoom:33%;"> <ul><li><p>geohash算法的相关操作</p></li> <li><ul><li>存储地址的经纬度坐标（按照z阶曲线进行Base32编码存储）</li> <li>返回地址的经纬度坐标（将信息解码），由于涉及到精度问题，返回的值和存入的值不完全一致</li> <li>计算两点坐标距离</li> <li>查找指定坐标范围内的其他坐标：通过遍历计算，O（N）复杂度</li></ul></li></ul> <p>Redis通过集合存储地点的GEO信息。</p> <h2 id="第十七章-hyperlog相关命令"><a href="#第十七章-hyperlog相关命令" class="header-anchor">#</a> 第十七章 HyperLog相关命令</h2> <p>对大基数内容进行统计的时候，使用set、bitmap存储可以获得高精度的解决方案，但是需要大量的空间。</p> <p>Redis使用HLL（超对数计数算法），降低一定的精度来解决基数计数问题。</p> <h2 id="第十八章-数据流相关命令"><a href="#第十八章-数据流相关命令" class="header-anchor">#</a> 第十八章 数据流相关命令</h2> <p>Redis 5.0.0引入了Stream，本章主要介绍Stream相关命令的底层实现。</p> <p>相关命令：xadd、xrange、xrevrange、xdel、xgroup、xreadgroup、xread、xack、xclaim、xinfo、xtrim、xlen。</p> <h2 id="第十九章-其他命令"><a href="#第十九章-其他命令" class="header-anchor">#</a> 第十九章 其他命令</h2> <p><strong>事务</strong></p> <p>Redis提供事务机制，开启事务后，接下来的命令将会入队而不是直接执行。</p> <p>在事务执行过程中，Redis不会执行其他命令，重启古城镇加载AOF文件也能包装事务命令的完整性。</p> <p>保障数据不会被篡改，Redis使用乐观锁机制，提供watch命令监听事务中重要的key，如果执行事务的时候这些key没有被修改才能成功执行事务。</p> <p><strong>发布订阅模式</strong></p> <p>相比于Stream来说，发布订阅模式不支持持久化和异步传输。</p> <p><strong>Lua脚本</strong></p> <p>支持运行Lua代码</p> <h2 id="第二十章-持久化"><a href="#第二十章-持久化" class="header-anchor">#</a> 第二十章 持久化</h2> <p>Redis是一个内存数据库，执行持久化时会生成子线程来完成持久化操作，支持三种持久化方案：</p> <ul><li>RDB，生成某个时间点前的快照。优点：恢复快，缺点：丢失数据多</li> <li>AOF，保持某个时间段Redis服务器的每一条命令。有点：丢失数据少，缺点：恢复慢</li> <li>RDB与AOF混合，保持某个时间点前的RDB，在执行RDB期间的命令用AOF保持，结合两者优点</li></ul> <h2 id="第二十一章-主从复制"><a href="#第二十一章-主从复制" class="header-anchor">#</a> 第二十一章 主从复制</h2> <img src="/assets/img/master_slave.21a7b6ff.png" alt="img" style="zoom:38%;"> <p>主从复制的最基础应用是主从模式，区别于Redis的单机模式，这里列举一下单机模式的优缺点</p> <p>优点：</p> <ol><li>部署简单</li> <li>成本低，不需要多服务器支持</li> <li>低访问量下高性能，不涉及到数据同步问题，在访问量不超过资源上限的情况下性能较高</li></ol> <p>缺点：</p> <ol><li>可靠性差，单机运行有宕机风险</li> <li>高访问量下低性能，受限于单机算力与带宽限制，高访问量下处理资源能力跟不上</li> <li>很难实现在线扩容和扩充资源</li></ol> <p>主从模式的优缺点</p> <p>优点：</p> <ol><li>读写分离，主服务器负责处理写命令，从服务器们负责处理读命令和持久化操作，他们之间再进行同步，这样可以提升Redis的服务能力。</li> <li>数据容灾，（主从模式 是哨兵模式和集群模式的基础）主服务器宕机了，可以让从服务器升级为主服务器，提升Redis的稳定性。（应用在哨兵模式或者集群模式下）</li></ol> <p>缺点：</p> <ol><li>不支持自动升级主服务器（在哨兵模式和集群模式下解决）</li> <li>所有写命令都需要在主节点上执行，同样会面临和单机模式一样的高访问量下低性能问题</li> <li>同步服务器数据消耗额外资源</li> <li>比较难实现在线扩容和扩充资源</li></ol> <p>主服务器响应主从复制的两种方式</p> <ol><li>完全同步：RDB快照+RDB快照后的命令缓存</li> <li>部分同步：RDB快照后的部分命令缓存</li></ol> <p>选择执行主从复制的流程</p> <img src="/assets/img/process.f2bdcce2.png" alt="img" style="zoom:38%;"> <p>提升主从复制效率：</p> <ol><li>从服务器通过持久化主从复制信息来提升主从复制速度，防止关闭重启后从新复制之前的信息</li> <li>主服务宕机了，从服务器进行升级为主服务器时，会存储主服务器的复制信息，响应其他服务器的主从复制命令</li></ol> <h2 id="第二十二章-哨兵和集群"><a href="#第二十二章-哨兵和集群" class="header-anchor">#</a> 第二十二章 哨兵和集群</h2> <p>哨兵模式：基于主从模式，哨兵模式增加了一个或多个哨兵服务器组成哨兵系统，哨兵系统可以监视所有数据服务器的运行状态，如果检测主服务器运行出现问题，可以重新选择从服务升级为主服务器。</p> <img src="/assets/img/sentinel.e9bf129e.png" alt="img" style="zoom:38%;"> <p>优点：</p> <ol><li><p>基于主从模式，具有主从模式的所有优点</p></li> <li><ol><li>读写分离</li> <li>数据容灾</li></ol></li> <li><p>自动选择主服务器，可用性更强</p></li></ol> <p>缺点：</p> <ol><li>比较难实现在线扩容和扩充资源</li> <li>需要保存数据同步</li></ol> <p>Sentinel的工作方式:</p> <p>1)：每个Sentinel以每秒钟一次的频率向它所知的Master，Slave以及其他 Sentinel 实例发送一个 PING 命令</p> <p>2)：如果一个实例（instance）距离最后一次有效回复 PING 命令的时间超过 down-after-milliseconds 选项所指定的值， 则这个实例会被 Sentinel 标记为主观下线。</p> <p>3)：如果一个Master被标记为主观下线，则正在监视这个Master的所有 Sentinel 要以每秒一次的频率确认Master的确进入了主观下线状态。</p> <p>4)：当有足够数量的 Sentinel（大于等于配置文件指定的值）在指定的时间范围内确认Master的确进入了主观下线状态， 则Master会被标记为客观下线</p> <p>5)：在一般情况下， 每个 Sentinel 会以每 10 秒一次的频率向它已知的所有Master，Slave发送 INFO 命令</p> <p>6)：当Master被 Sentinel 标记为客观下线时，Sentinel 向下线的 Master 的所有 Slave 发送 INFO 命令的频率会从 10 秒一次改为每秒一次</p> <p>7)：若没有足够数量的 Sentinel 同意 Master 已经下线， Master 的客观下线状态就会被移除。</p> <p>若 Master 重新向 Sentinel 的 PING 命令返回有效回复， Master 的主观下线状态就会被移除。</p> <p>集群模式：通过数据分片的方式，让不同的主从服务群能够处理不同的数据，以突破单一主服务器性能限制。</p> <img src="/assets/img/cluster.02a39faf.png" alt="img" style="zoom:38%;"> <p>优点：</p> <ol><li>基于哨兵模式，具有哨兵模式的所有优点</li></ol> <ul><li><ol><li>读写分离</li> <li>数据容灾</li> <li>自动选择主服务器</li></ol></li></ul> <ol><li>支持在线扩容（添加主从服务器群）</li> <li>支持共享从服务器(副本漂移）</li></ol> <p>缺点：</p> <ol><li>需要保存数据同步</li></ol></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新于: </span> <span class="time">3 months ago</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第一章-引言" class="sidebar-link reco-side-第一章-引言" data-v-70334359>第一章 引言</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第二章-简单动态字符串" class="sidebar-link reco-side-第二章-简单动态字符串" data-v-70334359>第二章 简单动态字符串</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第三章-跳跃表" class="sidebar-link reco-side-第三章-跳跃表" data-v-70334359>第三章 跳跃表</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第四章-压缩列表" class="sidebar-link reco-side-第四章-压缩列表" data-v-70334359>第四章 压缩列表</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第五章-字典" class="sidebar-link reco-side-第五章-字典" data-v-70334359>第五章 字典</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第六章-整数集合" class="sidebar-link reco-side-第六章-整数集合" data-v-70334359>第六章 整数集合</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第七章-快速列表" class="sidebar-link reco-side-第七章-快速列表" data-v-70334359>第七章 快速列表</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第八章-stream" class="sidebar-link reco-side-第八章-stream" data-v-70334359>第八章 Stream</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第九章-命令处理生命周期" class="sidebar-link reco-side-第九章-命令处理生命周期" data-v-70334359>第九章 命令处理生命周期</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第十章-键相关命令" class="sidebar-link reco-side-第十章-键相关命令" data-v-70334359>第十章 键相关命令</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第十一章-字符串相关命令" class="sidebar-link reco-side-第十一章-字符串相关命令" data-v-70334359>第十一章 字符串相关命令</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第十二章-散列表相关命令" class="sidebar-link reco-side-第十二章-散列表相关命令" data-v-70334359>第十二章 散列表相关命令</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第十三章-列表相关命令" class="sidebar-link reco-side-第十三章-列表相关命令" data-v-70334359>第十三章 列表相关命令</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第十四章-集合相关命令" class="sidebar-link reco-side-第十四章-集合相关命令" data-v-70334359>第十四章 集合相关命令</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第十五章-有序集合相关命令" class="sidebar-link reco-side-第十五章-有序集合相关命令" data-v-70334359>第十五章 有序集合相关命令</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第十六章geo相关命令" class="sidebar-link reco-side-第十六章geo相关命令" data-v-70334359>第十六章GEO相关命令</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第十七章-hyperlog相关命令" class="sidebar-link reco-side-第十七章-hyperlog相关命令" data-v-70334359>第十七章 HyperLog相关命令</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第十八章-数据流相关命令" class="sidebar-link reco-side-第十八章-数据流相关命令" data-v-70334359>第十八章 数据流相关命令</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第十九章-其他命令" class="sidebar-link reco-side-第十九章-其他命令" data-v-70334359>第十九章 其他命令</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第二十章-持久化" class="sidebar-link reco-side-第二十章-持久化" data-v-70334359>第二十章 持久化</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第二十一章-主从复制" class="sidebar-link reco-side-第二十一章-主从复制" data-v-70334359>第二十一章 主从复制</a></li><li class="level-2" data-v-70334359><a href="/content/category/notes/redis5_design_and_source_code_analysis/#第二十二章-哨兵和集群" class="sidebar-link reco-side-第二十二章-哨兵和集群" data-v-70334359>第二十二章 哨兵和集群</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----></div></div>
    <script src="/assets/js/app.581ce651.js" defer></script><script src="/assets/js/4.97ffefa2.js" defer></script><script src="/assets/js/1.dc92cade.js" defer></script><script src="/assets/js/6.920bd8f9.js" defer></script><script src="/assets/js/14.58c020f3.js" defer></script>
  </body>
</html>
