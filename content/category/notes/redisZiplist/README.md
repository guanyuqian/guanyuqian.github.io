---
title: Redis5 Ziplist 分析
# shell 根据创建时间自动生成
date: 2021-06-25 18:44:27
tags:
- Redis
- 数据库
- 数据结构
categories:
- 算法题解
# author: Guanyuqian
# sidebar: true
# 是否发布
# publish: false
# 文档加密，md5加密的32位密文
# keys:
# 	- 'e10adc3949ba59abbe56e057f20f883e'
# copyright: false # disable the plugin in this page 
# copyright:
#  minLength: 40 # It will override global configuration. 
---

::: warning

在本篇文章中，通过一些问题，对ziplist的一些关键特性进行归纳。

:::

<!-- more -->

## 前言

之前学习过Redis5的一些设计与实现，并且记录在了[《Redis 5 设计与源码分析》 学习笔记](https://www.guanyuqian.com/content/category/notes/Redis5DesignAndSourceCodeAnalysis/) 中。

其中最令人佩服的是Redis5的一些数据结构的设计，能够做到空间或者时间上面的极致。

ziplist就是其中一个很有代表性的数据结构。

在本篇文章中，通过一些问题，对ziplist的一些关键特性进行归纳。



## ziplist是什么？

ziplist是Redis一种作为**小数据量**的底层列表实现。本质上是一个存放在连续空间的**柔型数组**和**双向列表**，通过**特殊的编码**与**压缩**把空间利用到极致。

## ziplist的特点是什么？

- **小数据量：**ziplist是典型的以时间换空间的数据结构，Redis的多种基础类型（hash、zset）在小数据量场景都会使用到它。
- **柔性数组：**不限定存储元素规格的动态数组，比如柔性数组中的元素可以有8位、16位、32位、64位等多种整形结构。
- **双向列表：**称之为双向列表的原因是因为ziplist中采用柔性数组，每个数据的规格不一致，虽然所有数据是存放在连续的空间中的，但是访问其中的数据需要遍历，ziplist提供前后双向遍历。
- **特殊的编码：**对于不同规格的数据采用不同的编码格式进行区分，达到空间压缩的效果。
- **压缩：**对于其中的数据，使用**LSF**算法进行进一步压缩。

## prevlen字段是定长的吗？

再元素的存储结构中，第一个字段位prevlen，含义为前一个的元素尺寸。

为了节约空间，prevlen字段是变长的（1字节或者5字节）。

- **当前一个元素长度<254字节，**占用一字节，直接表示。

- **当前一个元素长度>=254字节，**占用5字节，而且**5字节中第一个字节固定为0xFE**(254，标记)，后面4字节才是真正表示前一个元素长度。

## ziplist是怎么实现插入/删除的？

大致的原理是找到插入的位置，计算插入/删除后的空间，然后申请新的空间，把新的数据挪过去。

**ziplist插入/删除可能会导致一系列元素尺寸变大：**因为插入/删除可能会更改后续元素的prevlen字段的规格，从而改变后续元素的尺寸。

- 如果导致元素缩小了，担心会产生额外的连锁效应，就会填充信号字段在其中。

- 但是导致元素增大了，就不能用这个方法了。



## ziplist最大的缺陷是什么？

由于**“ziplist插入/删除可能会导致一系列元素尺寸变大”**，可能会导致**连锁更新**问题。

即，因为插入/删除元素导致后续一个元素发生尺寸变化，需要额外申请新的空间，后续元素又会导致后续元素的后续元素发生变化，需要申请新的空间，以此类推。**O(n)** 的复杂度会上升为**O(n^2)** 。

连锁更新会导致多次重新分配内存及数据复制，效率很低，但**一般出现这种概率的情况比较低**，因此redis并没有采取有效的措施避免连锁更新。 

**所以连锁更新在遇到prevlen大小没变化，及需要减小prevlen时，会停止连锁更新。**



## 为什么不一次性计算出后面所有字段的长度变化再申请内存？

因为ziplist每次计算的过程都需要对每个元素进行编解码，move改变其相对位置。如果统一计算出所有的字段，就不能做到同步move，需要额外进行计算和move，或者需要额外的空间存储每个节点的prevlen字段。ziplist的特点是省空间，这种操作并不会带来太明显的性能提示，并且给可扩展性带来限制。

